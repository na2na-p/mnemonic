# Android Template Builder
# krkrsdl2をビルドしてAndroidテンプレートを生成するワークフロー
#
# 手動実行: Actions > Build Android Template > Run workflow
#   - バージョン未指定時は CalVer (template-YYYY.MM.DD) で自動リリース
# 自動実行: template-20*タグがプッシュされた時

name: Build Android Template

on:
  workflow_dispatch:
    inputs:
      krkrsdl2_ref:
        description: 'krkrsdl2 ref (branch, tag, or commit)'
        required: false
        default: 'main'
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    tags:
      - 'template-20*'

permissions:
  contents: write

env:
  KRKRSDL2_REPO: krkrsdl2/krkrsdl2
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build:
    name: Build krkrsdl2 Android Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout mnemonic
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android SDK components
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/ndk/21.4.7075529
            ${{ env.ANDROID_SDK_ROOT }}/cmake/3.22.1
          key: android-sdk-ndk21.4-cmake3.22

      - name: Install Android SDK components
        run: |
          # Only install if not cached
          [ -d "$ANDROID_SDK_ROOT/ndk/21.4.7075529" ] || sdkmanager --install "ndk;21.4.7075529"
          [ -d "$ANDROID_SDK_ROOT/cmake/3.22.1" ] || sdkmanager --install "cmake;3.22.1"
          sdkmanager --install "platforms;android-26" "build-tools;30.0.3"

      - name: Cache krkrsdl2 repository
        uses: actions/cache@v4
        id: cache-krkrsdl2
        with:
          path: krkrsdl2
          key: krkrsdl2-${{ github.event.inputs.krkrsdl2_ref || 'main' }}

      - name: Clone krkrsdl2
        if: steps.cache-krkrsdl2.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.krkrsdl2_ref || 'main' }} \
            https://github.com/${{ env.KRKRSDL2_REPO }}.git krkrsdl2
          cd krkrsdl2
          git submodule update --init --recursive

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Build Android project
        working-directory: krkrsdl2/android-project
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Prepare template package
        run: |
          mkdir -p template-output

          # Copy APK (for reference/testing)
          cp krkrsdl2/android-project/app/build/outputs/apk/release/*.apk \
             template-output/ || true

          # Create template structure
          mkdir -p template-output/template

          # Copy native libraries (.so files)
          cp -r krkrsdl2/android-project/app/build/intermediates/cxx/Release/*/obj/* \
                template-output/template/jniLibs/ 2>/dev/null || \
          cp -r krkrsdl2/android-project/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib/* \
                template-output/template/jniLibs/ 2>/dev/null || true

          # Copy Java/Kotlin source
          cp -r krkrsdl2/android-project/app/src/main/java \
                template-output/template/ 2>/dev/null || true

          # Copy resources
          cp -r krkrsdl2/android-project/app/src/main/res \
                template-output/template/ 2>/dev/null || true

          # Copy manifest
          cp krkrsdl2/android-project/app/src/main/AndroidManifest.xml \
             template-output/template/

          # Copy gradle files (for reference)
          cp krkrsdl2/android-project/app/build.gradle \
             template-output/template/build.gradle.template

          # Create version info
          cd krkrsdl2
          echo "krkrsdl2_commit=$(git rev-parse HEAD)" > ../template-output/VERSION
          echo "krkrsdl2_ref=${{ github.event.inputs.krkrsdl2_ref || 'main' }}" >> ../template-output/VERSION
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> ../template-output/VERSION

      - name: Create template archive
        run: |
          cd template-output
          zip -r ../android-template.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-template
          path: android-template.zip
          retention-days: 30

      - name: Determine release version (CalVer)
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/template-* ]]; then
            # Tag push: use tag name
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            # Manual dispatch with release: generate CalVer
            CALVER="template-$(date -u +%Y.%m.%d)"
            echo "version=${CALVER}" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Android Template ${{ steps.version.outputs.version }}
          files: android-template.zip
          generate_release_notes: true
          draft: false
          prerelease: false
