# Android Template Builder
# krkrsdl2をビルドしてAndroidテンプレートを生成するワークフロー
#
# 手動実行: Actions > Build Android Template > Run workflow
# 自動実行: v*タグがプッシュされた時

name: Build Android Template

on:
  workflow_dispatch:
    inputs:
      krkrsdl2_ref:
        description: 'krkrsdl2 ref (branch, tag, or commit)'
        required: false
        default: 'main'
  push:
    tags:
      - 'template-v*'

env:
  KRKRSDL2_REPO: krkrsdl2/krkrsdl2

jobs:
  build:
    name: Build krkrsdl2 Android Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout mnemonic
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          sdkmanager --install "ndk;21.4.7075529"
          sdkmanager --install "cmake;3.22.1"
          sdkmanager --install "platforms;android-26"
          sdkmanager --install "build-tools;30.0.3"

      - name: Clone krkrsdl2
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.krkrsdl2_ref || 'main' }} \
            https://github.com/${{ env.KRKRSDL2_REPO }}.git krkrsdl2
          cd krkrsdl2
          git submodule update --init --recursive

      - name: Build Android project
        working-directory: krkrsdl2/android-project
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Prepare template package
        run: |
          mkdir -p template-output

          # Copy APK (for reference/testing)
          cp krkrsdl2/android-project/app/build/outputs/apk/release/*.apk \
             template-output/ || true

          # Create template structure
          mkdir -p template-output/template

          # Copy native libraries (.so files)
          cp -r krkrsdl2/android-project/app/build/intermediates/cxx/Release/*/obj/* \
                template-output/template/jniLibs/ 2>/dev/null || \
          cp -r krkrsdl2/android-project/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib/* \
                template-output/template/jniLibs/ 2>/dev/null || true

          # Copy Java/Kotlin source
          cp -r krkrsdl2/android-project/app/src/main/java \
                template-output/template/ 2>/dev/null || true

          # Copy resources
          cp -r krkrsdl2/android-project/app/src/main/res \
                template-output/template/ 2>/dev/null || true

          # Copy manifest
          cp krkrsdl2/android-project/app/src/main/AndroidManifest.xml \
             template-output/template/

          # Copy gradle files (for reference)
          cp krkrsdl2/android-project/app/build.gradle \
             template-output/template/build.gradle.template

          # Create version info
          cd krkrsdl2
          echo "krkrsdl2_commit=$(git rev-parse HEAD)" > ../template-output/VERSION
          echo "krkrsdl2_ref=${{ github.event.inputs.krkrsdl2_ref || 'main' }}" >> ../template-output/VERSION
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> ../template-output/VERSION

      - name: Create template archive
        run: |
          cd template-output
          zip -r ../android-template.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-template
          path: android-template.zip
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/template-v')
        uses: softprops/action-gh-release@v2
        with:
          files: android-template.zip
          generate_release_notes: true
